function Convert_Pixels2Meters(e,t){if(t=="w")return e*Surface.Width/window.innerWidth;if(t=="h")return e*Surface.Height/window.innerHeight}function Convert_Meters2Pixels(e,t){if(t=="w")return e*(window.innerWidth/Surface.Width);if(t=="h")return e*(window.innerHeight/Surface.Height)}function round(e,t){return Math.round(e*Math.pow(10,t))/Math.pow(10,t)}function kdTree(e,t,n){function r(e,t,n){this.obj=e;this.left=null;this.right=null;this.parent=n;this.dimension=t}function s(e,t,i){var o=t%n.length;if(e.length==0)return null;if(e.length==1)return new r(e[0],o,i);e.sort(function(e,t){return e[n[o]]-t[n[o]]});var u=Math.floor(e.length/2);var a=new r(e[u],o,i);a.left=s(e.slice(0,u),t+1,a);a.right=s(e.slice(u+1),t+1,a);return a}function o(e){this.content=[];this.scoreFunction=e}var i=this;this.root=s(e,0,null);this.insert=function(e){function u(t,r){if(t==null)return r;var i=n[t.dimension];if(e[i]<t.obj[i]){return u(t.left,t)}else{return u(t.right,t)}}var t=u(i.root,null);if(t==null){i.root=new r(e,0,null);return}var s=new r(e,(t.dimension+1)%n.length,t);var o=n[t.dimension];if(e[o]<t.obj[o]){t.left=s}else{t.right=s}};this.remove=function(e){function r(t){if(t==null)return null;if(t.obj===e)return t;var i=n[t.dimension];if(e[i]<t.obj[i]){return r(t.left,t)}else{return r(t.right,t)}}function s(e){function u(e,t){if(e==null)return null;var r=n[t];if(e.dimension==t){if(e.right!=null)return u(e.right,t);return e}var i=e.obj[r];var s=u(e.left,t);var o=u(e.right,t);var a=e;if(s!=null&&s.obj[r]>i)a=s;if(o!=null&&o.obj[r]>a.obj[r])a=o;return a}function a(e,t){if(e==null)return null;var r=n[t];if(e.dimension==t){if(e.left!=null)return a(e.left,t);return e}var i=e.obj[r];var s=a(e.left,t);var o=a(e.right,t);var u=e;if(s!=null&&s.obj[r]<i)u=s;if(o!=null&&o.obj[r]<u.obj[r])u=o;return u}if(e.left==null&&e.right==null){if(e.parent==null){i.root=null;return}var t=n[e.parent.dimension];if(e.obj[t]<e.parent.obj[t]){e.parent.left=null}else{e.parent.right=null}return}if(e.left!=null){var r=u(e.left,e.dimension)}else{var r=a(e.right,e.dimension)}var o=r.obj;s(r);e.obj=o}var t=r(i.root);if(t==null)return;s(t)};this.nearest=function(e,r,s){function a(i){function p(e,t){bestNodes.push([e,t]);if(bestNodes.size()>r){bestNodes.pop()}}var s;var o=n[i.dimension];var u=t(e,i.obj);var f={};for(var l=0;l<n.length;l++){if(l==i.dimension){f[n[l]]=e[n[l]]}else{f[n[l]]=i.obj[n[l]]}}var c=t(f,i.obj);if(i.right==null&&i.left==null){if(bestNodes.size()<r||u<bestNodes.peek()[1]){p(i,u)}return}if(i.right==null){s=i.left}else if(i.left==null){s=i.right}else{if(e[o]<i.obj[o]){s=i.left}else{s=i.right}}a(s);if(bestNodes.size()<r||u<bestNodes.peek()[1]){p(i,u)}if(bestNodes.size()<r||Math.abs(c)<bestNodes.peek()[1]){var h;if(s==i.left){h=i.right}else{h=i.left}if(h!=null)a(h)}}bestNodes=new o(function(e){return-e[1]});if(s){for(var u=0;u<r;u++){bestNodes.push([null,s])}}a(i.root);var f=[];for(var u=0;u<r;u++){if(bestNodes.content[u][0]){f.push([bestNodes.content[u][0].obj,bestNodes.content[u][1]])}}return f};this.balanceFactor=function(){function e(t){if(t==null)return 0;return Math.max(e(t.left),e(t.right))+1}function t(e){if(e==null)return 0;return t(e.left)+t(e.right)+1}return e(i.root)/(Math.log(t(i.root))/Math.log(2))};o.prototype={push:function(e){this.content.push(e);this.bubbleUp(this.content.length-1)},pop:function(){var e=this.content[0];var t=this.content.pop();if(this.content.length>0){this.content[0]=t;this.sinkDown(0)}return e},peek:function(){return this.content[0]},remove:function(e){var t=this.content.length;for(var n=0;n<t;n++){if(this.content[n]==e){var r=this.content.pop();if(n!=t-1){this.content[n]=r;if(this.scoreFunction(r)<this.scoreFunction(e))this.bubbleUp(n);else this.sinkDown(n)}return}}throw new Error("Node not found.")},size:function(){return this.content.length},bubbleUp:function(e){var t=this.content[e];while(e>0){var n=Math.floor((e+1)/2)-1,r=this.content[n];if(this.scoreFunction(t)<this.scoreFunction(r)){this.content[n]=t;this.content[e]=r;e=n}else{break}}},sinkDown:function(e){var t=this.content.length,n=this.content[e],r=this.scoreFunction(n);while(true){var i=(e+1)*2,s=i-1;var o=null;if(s<t){var u=this.content[s],a=this.scoreFunction(u);if(a<r)o=s}if(i<t){var f=this.content[i],l=this.scoreFunction(f);if(l<(o==null?r:a))o=i}if(o!=null){this.content[e]=this.content[o];this.content[o]=n;e=o}else{break}}}}}function dbScan(e,t,n,r){function o(){this.points=[];this.minx=999999999;this.miny=999999999;this.maxx=-999999999;this.maxy=-999999999;this.avgx=new KnuthVariance;this.avgy=new KnuthVariance;this.sigmaX=0;this.sigmaY=0;this.sigmaX2=0;this.sigmaXY=0;this.addPoint=function(e){this.points.push(e);this.minx=Math.min(e.x,this.minx);this.miny=Math.min(e.y,this.miny);this.maxx=Math.max(e.x,this.maxx);this.maxy=Math.max(e.y,this.maxy);this.avgx.push(e.x);this.avgy.push(e.y);this.sigmaX+=e.x;this.sigmaY+=e.y;this.sigmaX2+=e.x*e.x;this.sigmaXY+=e.x*e.y};this.slope=function(){return(this.points.length*this.sigmaXY-this.sigmaX*this.sigmaY)/(this.points.length*this.sigmaX2-this.sigmaX*this.sigmaX)};this.intercept=function(){return(this.sigmaY-this.slope()*this.sigmaX)/this.points.length};this.aspectratio=function(){if(this.points.length==1)return 1;return(this.maxx-this.minx)/(this.maxy-this.miny)};this.volume=function(){var e=this.maxx-this.minx;var t=this.maxy-this.miny;return e*t};this.centerx=function(){return this.avgx.mean()};this.centery=function(){return this.avgy.mean()};this.radius=function(){x=this.centerx();y=this.centerx();var e=Math.abs(Math.pow(this.minx-x,2)+Math.pow(this.miny-y,2));var t=Math.abs(Math.pow(this.maxx-x,2)+Math.pow(this.maxy-y,2));return Math.sqrt(Math.max(t,e))}}function a(e){var n=h.nearest(e,100,t*t);var r=[];for(var i=0;i<n.length;++i)r.push(n[i][0]);return r}function f(e,t,r){r.points.push(e);e.cluster=r;while((dNPoint=t.pop())!=undefined){if(!!!dNPoint.visited){dNPoint.visited=true;var i=a(dNPoint);if(i.length>=n){t=t.concat(i.filter(function(e){return!!!e.visited}))}}if(!!!dNPoint.cluster){r.addPoint(dNPoint);dNPoint.cluster=r}}}var i=[];var s=r||false;var u=function(e,t){return Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2)};var l=e;if(!s){l=[];for(var c=0;c<e.length;c++)l.push({x:e[c].x,y:e[c].y,cluster:null})}var h=new kdTree(l,u,["x","y"]);for(var c=0;c<l.length;++c){if(!!l[c].visited)continue;l[c].visited=true;var p=a(l[c]);if(p.length<n){l[c].noise=true}else{var d=new o;i.push(d);f(l[c],p,d)}}return i}function TouchPoint(e,t){this.processor=e;this.colour=this.processor._nextColour();this.avgx=t.centerx();this.smoothx=new KalmanDouble(t.centerx());this.smoothx.noise=.05;this.avgy=t.centery();this.smoothy=new KalmanDouble(t.centery());this.smoothy.noise=.05;this.lastcluster=t;this.stronglock=false;this.id=this.processor.TrackerCount++;this.iFrameCount=0;this.lastupdate=(new Date).getTime();this.iDeathTracker=0;this.centerx=function(){return this.avgx};this.centery=function(){return this.avgy};this.x=function(){return this.smoothx.get()/100};this.y=function(){return this.smoothy.get()/100};this._visual=null;this._label=null;this.consume=function(e){this.iFrameCount++;this.avgx=e.centerx();this.smoothx.push(e.centerx());this.avgy=e.centery();this.smoothy.push(e.centery());this.lastcluster=e;this.iDeathTracker=0;if(this.iFrameCount==this.processor.FramePersistance){this.stronglock=true;if(this.processor.DispatchStart!=null){this.processor.DispatchStart(this)}if(this.processor._DebugLayerStatic){this._visual=document.createElement("div");this.processor._DebugLayerStatic.appendChild(this._visual);this._visual.style.pointerEvents="none";this._visual.style.position="absolute";this._visual.style.left=this.centerx()+"%";this._visual.style.top=this.centery()+"%";this._visual.style.width=this.processor.DebugVoxelWidth*2+"px";this._visual.style.height=this.processor.DebugVoxelHeight*2+"px";this._visual.style.marginTop=-this.processor.DebugVoxelHeight+"px";this._visual.style.marginLeft=-this.processor.DebugVoxelWidth+"px";this._visual.style.borderRadius=this.processor.DebugVoxelWidth*2+"px";this._visual.style.backgroundColor=this.colour;this._visual.style.opacity=.8;this._visual.style.border="1px solid white";this._label=null}}if(this.stronglock){if(this.processor.DispatchMove!=null){this.processor.DispatchMove(this)}}if(this.processor._DebugLayerStatic){if(this._visual){this._visual.style.left=this.smoothx.get()+"%";this._visual.style.top=this.smoothy.get()+"%"}if(this._label){this._label.style.left=this.smoothx.get()+"%";this._label.style.top=this.smoothy.get()+"%"}}};this.consumeNothing=function(){if(this.iDeathTracker>=4)return true;this.iDeathTracker++;return false};this.remove=function(){if(this.stronglock){if(this.processor.DispatchStop!=null){this.processor.DispatchStop(this)}}if(this._visual)this.processor._DebugLayerStatic.removeChild(this._visual);if(this._label)this.processor._DebugLayerStatic.removeChild(this._label)}}function KinectMultiTouch_HandlePointCloud(e){var t=[];for(var n=0;n<e.length;++n){t.push({x:Math.abs(e[n][0])*100,y:Math.abs(e[n][1])*100,z:Math.abs(e[n][2])*100})}_KinectTouchInstance.process(t)}(function(){var e=false,t=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;this.Class=function(){};Class.extend=function(n){function o(){if(!e&&this.init)this.init.apply(this,arguments)}var r=this.prototype;e=true;var i=new this;e=false;for(var s in n){i[s]=typeof n[s]=="function"&&typeof r[s]=="function"&&t.test(n[s])?function(e,t){return function(){var n=this._super;this._super=r[e];var i=t.apply(this,arguments);this._super=n;return i}}(s,n[s]):n[s]}o.prototype=i;o.prototype.constructor=o;o.extend=arguments.callee;return o}})();var KalmanDouble=Class.extend({A:1,B:0,H:1,Q:.01,P:1,noise:.4,value:0,last:0,init:function(e){this.reset(e||0)},reset:function(e){this.LP=.1;this.value=e;this.last=e},push:function(e){this.last=this.A*this.last;this.LP=this.A*this.LP*this.A+this.Q;var t=this.LP*this.H/(this.H*this.LP*this.H+this.noise);this.last=this.last+t*(e-this.H*this.last);this.LP=(1-t*this.H)*this.LP;this.value=this.last},get:function(){return this.value}});var MovingVariance=Class.extend({data:[],count:0,length:10,idx:0,total:0,init:function(e){this.length=e||25;this.reset(this.length)},reset:function(e){this.data=[];for(var t=0;t<this.length;++t)this.data.push(0);this.count=0},push:function(e){if(this.count==this.length){this.total-=this.data[this.idx]}this.data[this.idx]=e;this.total+=e;++this.idx;++this.count;if(this.count>this.length)this.count=this.length;if(this.idx==this.length)this.idx=0},numvalues:function(){return this.count},mean:function(){return this.count>0?this.total/this.count:0},variance:function(){var e=this.mean();var t=this.count;var n=0;while(t--){n+=Math.pow(this.data[t]-e,2)}n/=this.count;return n},std:function(){return Math.sqrt(this.variance())}});var KnuthVariance=Class.extend({n:0,_oldM:0,_newM:0,_oldS:0,_newS:0,init:function(){this.reset()},reset:function(){this.n=0},push:function(e){this.n++;if(this.n==1){this._oldM=this._newM=e;this._oldS=0}else{this._newM=this._oldM+(e-this._oldM)/this.n;this._newS=this._oldS+(e-this._oldM)*(e-this._newM);this._oldM=this._newM;this._oldS=this._newS}},numvalues:function(){return this.n},mean:function(){return this.n>0?this._newM:0},variance:function(){return this.n>1?this._newS/(this.n-1):0},std:function(){return Math.sqrt(this.variance())}});var TouchTracker=Class.extend({FramePersistance:2,TrackerCount:0,TouchRemoveTime:100,DebugVoxelWidth:2,DebugVoxelHeight:2,KinectVoxel:.005,DistanceCutOff:.07,LargestFinger:.04,DebugColours:["red","green","blue","yellow","orange","lime"],_Debug:false,_DebugLayer:null,_Tracked:[],DispatchStart:null,DispatchStop:null,DispatchMove:null,init:function(e){this.debug(e.debug||false);this.trails(e.trails||false);this.DispatchStart=e.start||null;this.DispatchStop=e.stop||null;this.DispatchMove=e.update||null;this.updateSurface()},process:function(e){this.updateSurface();if(this._DebugLayer){while(this._DebugLayer.hasChildNodes()){this._DebugLayer.removeChild(this._DebugLayer.lastChild)}}var t=300*this.DebugVoxelWidth/window.innerWidth;var n=dbScan(e,t,5,true);var r=this._Tracked;var i=[];for(var s=0;s<n.length;++s){var o=n[s].volume();var u=100*Convert_Meters2Pixels(this.LargestFinger,"w")/window.innerWidth;var a=100*Convert_Meters2Pixels(this.LargestFinger,"h")/window.innerWidth;var f=u*a;if(o>f)continue;i.push(n[s])}var l=[];for(var s=0;s<r.length;++s){var c=r[s];for(var h=0;h<i.length;++h){var p=i[h];var d=Math.pow(p.centerx()-c.centerx(),2)+Math.pow(p.centery()-c.centery(),2);var v=100*Convert_Meters2Pixels(this.DistanceCutOff,"w")/window.innerWidth;if(d<v*v)l.push({cluster:p,tracker:c,rank:d})}}l=l.sort(function(e,t){if(e.rank<t.rank)return-1;if(e.rank>t.rank)return 1;return 0});for(var s=0;s<r.length;++s)r[s].assigned=false;for(var s=0;s<i.length;++s)i[s].assigned=false;for(var s=0;s<l.length;++s){if(l[s].cluster.assigned==true||l[s].tracker.assigned==true)continue;l[s].tracker.consume(l[s].cluster);l[s].cluster.assigned=true;l[s].tracker.assigned=true}for(var s=0;s<i.length;++s){if(i[s].assigned==false){var c=new TouchPoint(this,i[s]);r.push(c)}}var m=[];for(var s=0;s<r.length;++s){if(r[s].assigned==false){if(r[s].consumeNothing())m.push(s)}}m.sort();m.reverse();for(var s=0;s<m.length;++s){if(r[m[s]])r[m[s]].remove();r.splice(m[s],1)}if(this._DebugLayer){for(var s=0;s<r.length;++s){var g=r[s];var y=g.lastcluster.points;for(var b=0;b<y.length;++b){var w=document.createElement("div");w.style.position="absolute";w.style.width=this.DebugVoxelWidth+"px";w.style.height=this.DebugVoxelHeight+"px";w.style.backgroundColor=g.stronglock?g.colour:"#CCC";w.style.opacity="0.3";w.style.left=y[b].x+"%";w.style.top=y[b].y+"%";this._DebugLayer.appendChild(w)}}}},debug:function(e){this._Debug=e;if(this._Debug){this._DebugLayerStatic=document.createElement("div");document.body.appendChild(this._DebugLayerStatic);this._DebugLayerStatic.style.width="100%";this._DebugLayerStatic.style.height="100%";this._DebugLayerStatic.style.top="0";this._DebugLayerStatic.style.left="0";this._DebugLayerStatic.style.zIndex="999";this._DebugLayerStatic.style.pointerEvents="none";this._DebugLayerStatic.style.pointerEvents="none";this._DebugLayerStatic.style.position="absolute"}else{if(this._DebugLayerStatic)document.body.removeChild(this._DebugLayerStatic);this._DebugLayerStatic=null}},trails:function(e){if(e){this._DebugLayer=document.createElement("div");document.body.appendChild(this._DebugLayer);this._DebugLayer.style.width="100%";this._DebugLayer.style.height="100%";this._DebugLayer.style.top="0";this._DebugLayer.style.left="0";this._DebugLayer.style.zIndex="999";this._DebugLayer.style.pointerEvents="none";this._DebugLayer.style.position="absolute"}else{if(this._DebugLayer)document.body.removeChild(this._DebugLayer);this._DebugLayer=null}},updateSurface:function(){this.DebugVoxelWidth=this.KinectVoxel*(window.innerWidth/Surface.Width);this.DebugVoxelHeight=this.KinectVoxel*(window.innerHeight/Surface.Height)},_nextColour:function(){var e=this.DebugColours.splice(0,1)[0];this.DebugColours.push(e);return e}});var MultiTouch={START:3,MOVE:4,END:5,cursors:[],_data:{},_touchstart:function(e){this._create_event("touchstart",e,{})},_touchmove:function(e){this._create_event("touchmove",e,{})},_touchend:function(e){this._create_event("touchend",e,{})},_create_event:function(e,t,n){var r=document.createEvent("UIEvent");r.initUIEvent(e,true,true);r.touches=this.cursors;r.targetTouches=this._get_target_touches(t.target);r.changedTouches=[t];if(t.target){t.target.dispatchEvent(r)}else{document.dispatchEvent(r)}},_get_target_touches:function(e){var t=[];for(var n=0;n<this.cursors.length;n++){var r=this.cursors[n];if(r.target==e){t.push(r)}}return t},inject:function(e,t,n,r,i){var s;if(e!==MultiTouch.START){s=this._data[t]}else{s={sid:t};this._data[t]=s}s.identifier=t;s.pageX=window.innerWidth*n;s.pageY=window.innerHeight*r;s.target=document.elementFromPoint(s.pageX,s.pageY);s.devicetouch=i;switch(e){case MultiTouch.START:this.cursors.push(s);this._touchstart(s);break;case MultiTouch.MOVE:this._touchmove(s);break;case MultiTouch.END:this.cursors.splice(this.cursors.indexOf(s),1);this._touchend(s);break}if(e===MultiTouch.END)delete this._data[t]}};var _KinectTouchInstance=null;var KinectTouch=Class.extend({init:function(e){if(_KinectTouchInstance!=null)throw"Error";_KinectTouchInstance=this;var t={point_limit:200,height:.01,relativeto:Surface.Name,surface_zoffset:.001,callback:"KinectMultiTouch_HandlePointCloud"};for(var n in e)t[n]=e[n];this.kLastLoop=new Date;this.fFps=0;this.fFrameTime=0;this.processor=new TouchTracker({debug:e.debug||false,trails:e.trails||false,start:function(e){MultiTouch.inject(MultiTouch.START,e.id,e.x(),e.y(),e)},stop:function(e){MultiTouch.inject(MultiTouch.END,e.id,e.x(),e.y(),e)},update:function(e){MultiTouch.inject(MultiTouch.MOVE,e.id,e.x(),e.y(),e)}});Authority.request("KinectLowestPointCube",t)},enableDebug:function(e){this.processor.debug(e)},updateSurface:function(){this.processor.updateSurface()},process:function(e){var t=new Date;this.fFps=1e3/(t-this.kLastLoop);this.kLastLoop=t;var n=(new Date).getMilliseconds();this.processor.process(e);var r=(new Date).getMilliseconds();this.fFrameTime=r-n},fps:function(){return this.fFps},processTime:function(){return this.fFrameTime}});
mt=new KinectTouch({debug:true,trails:false,point_limit:200,surface_zoffset:.015,height:.01})